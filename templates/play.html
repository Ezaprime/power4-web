{{define "play"}}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Power 4 â€“ Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="center-wrapper">
    <header class="app-header">
      <div class="brand"><div class="dot"></div><span>POWER 4</span></div>
      <nav class="nav">
        <form action="/reset" method="GET" style="display:inline">
          <button class="btn ghost" type="submit">ğŸ  Accueil</button>
        </form>
      </nav>
    </header>

    <div class="page" id="view" data-view="play">
      <div class="top">
        <span class="tag">DifficultÃ© : {{.Difficulty}}</span>
        <span id="turnTag" class="tag">Tour :
          {{if eq .Current 1}}ğŸ”¶ {{.Player1}}{{else}}ğŸ”· {{.Player2}}{{end}}
        </span>
      </div>

      <h1>{{.Player1}} (1) vs {{.Player2}} (2)</h1>

      <div class="board-wrap">
        <table class="board" id="board" aria-label="Plateau Power 4">
          <tbody>
          {{range $r, $row := .Grid}}
            <tr>
              {{range $c, $val := $row}}
                <td>
                  <div
                    class="cell {{if eq $val 1}}p1{{else if eq $val 2}}p2{{end}}"
                    data-row="{{$r}}"
                    data-col="{{$c}}">
                  </div>
                </td>
              {{end}}
            </tr>
          {{end}}
          </tbody>
        </table>
      </div>

      <div class="columns" id="colButtons">
        {{range .ColumnIndexes}}
          <button type="button" data-col="{{.}}">Col {{.}}</button>
        {{end}}
      </div>

      <div class="actions">
        <form action="/reset" method="POST">
          <button class="btn" type="submit">ğŸ” Rejouer</button>
        </form>
        <form action="/reset" method="GET" style="display:inline">
          <button class="btn ghost" type="submit">ğŸ  Accueil</button>
        </form>
      </div>
    </div>
  </div>

  <script>
  // --- Jeu sans reload ---
  async function playMove(col) {
    try {
      const empties = Array.from(document.querySelectorAll(`.cell[data-col='${col}']`))
        .filter(c => !c.classList.contains("p1") && !c.classList.contains("p2"));
      if (empties.length) {
        const target = empties[empties.length - 1];
        target.classList.add("drop-target");
        setTimeout(()=>target.classList.remove("drop-target"), 400);
      }
    } catch(e){}

    const formData = new FormData();
    formData.append("col", col);

    let html;
    try {
      const res = await fetch("/play", { method:"POST", body:formData, redirect:"follow" });
      html = await res.text();
    } catch(e){ return console.error(e); }

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const isResult = doc.querySelector('[data-view="result"]');
    if (isResult) return window.location.href = "/";

    const newBoard = doc.querySelector("#board");
    const newTurn  = doc.querySelector("#turnTag");
    if (newBoard) document.querySelector("#board").innerHTML = newBoard.innerHTML;
    if (newTurn)  document.querySelector("#turnTag").innerHTML = newTurn.innerHTML;
    bindUI();
  }

  function bindUI(){
    document.querySelectorAll(".cell").forEach(c=>c.onclick=()=>playMove(c.dataset.col));
    document.querySelectorAll("#colButtons [data-col]").forEach(b=>b.onclick=()=>playMove(b.dataset.col));
  }
  bindUI();
  </script>
</body>
</html>
{{end}}
